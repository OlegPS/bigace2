<?php
//
// +------------------------------------------------------------------------+
// | BIGACE - a PHP based Web CMS for MySQL                                 |
// +------------------------------------------------------------------------+
// | Copyright (c) Kevin Papst                                              |
// | Web           http://www.bigace.de                                     |
// | Mirror        http://bigace.sourceforge.net/                           |
// | Sourceforge   http://sourceforge.net/projects/bigace/                  |
// +------------------------------------------------------------------------+
// | This source file is subject to version 2 or (at your option) any later |
// | version, of the GNU General Public License as published by the Free    |
// | Software Foundation, available at:                                     |
// | http://www.gnu.org/licenses/gpl.html                                   |
// +------------------------------------------------------------------------+
// | This program is distributed in the hope that it will be useful,        |
// | but WITHOUT ANY WARRANTY; without even the implied warranty of         |
// | MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the          |
// | GNU General Public License for more details.                           |
// +------------------------------------------------------------------------+
//

/**
 * This Command is specialized for handling administration requests.
 * 
 * For further information visit {@link http://www.bigace.de http://www.bigace.de}.
 *
 * @license http://opensource.org/licenses/gpl-license.php GNU Public License
 * @author Kevin Papst 
 * @copyright Copyright (C) Kevin Papst
 * @version $Id$
 * @package bigace.command
 */

import('classes.exception.ExceptionHandler');
import('classes.exception.NotAllowedException');
import('classes.exception.NotFoundException');

// a boolean variable in the global scope with this name 
// defines whether the footer will be shown or not  
define('HIDE_ADMIN_FOOTER', 'hideAdminFooter');

// Language to display Administration in
$adminLang = new Language($GLOBALS['_BIGACE']['PARSER']->getLanguage());
if($adminLang->isAdminLanguage()) {
    define('ADMIN_LANGUAGE', $GLOBALS['_BIGACE']['PARSER']->getLanguage());
} else {
    define('ADMIN_LANGUAGE', 'en');
}

// the width for all large tables (to have a overall size)
define('ADMIN_MASK_WIDTH_LARGE', '100%');
// the width for all smaller tables (to have a overall size)
define('ADMIN_MASK_WIDTH_SMALL', '750px');

$GLOBALS[HIDE_ADMIN_FOOTER] = FALSE;

if (!$GLOBALS['_BIGACE']['SESSION']->isAnonymous()) 
{        
        // ----------------------------------------------------------------------------
        // ------------        SET UP THE ADMINISTRATION ENVIRONMENT       ------------
        // ----------------------------------------------------------------------------
        //definition to make sure each script is included only within a proper set up environment
        define('_VALID_ADMINISTRATION', '_IN_ADMINISTRATION');
        // plugin start directory
        define('_ADMIN_PLUGIN_DIRECTORY', _BIGACE_DIR_ADMIN . 'plugins/');
        // plugin start directory
        define('_ADMIN_INCLUDE_DIRECTORY', _BIGACE_DIR_ADMIN . 'plugins/includes/');
        // template directory
        define('_ADMIN_TEMPLATE_DIRECTORY', _BIGACE_DIR_ADMIN . 'templates/');
                
        import('classes.right.RightService');
        import('classes.fright.FrightService');
        import('classes.template.TemplateService');
		import('classes.util.IOHelper');
        import('classes.util.LinkHelper');
        import('classes.util.CMSLink');
        import('classes.util.Translations');

        import('classes.item.MasterItemType');
        import('classes.item.Item');
        import('classes.item.Itemtype');
        import('classes.item.ItemService');
        
        require_once(_BIGACE_DIR_ADMIN.'styling.php');
        require_once(_BIGACE_DIR_ADMIN.'functions.inc.php');
        
        $FRIGHT_SERVICE = new FrightService();
        $RIGHT_SERVICE = new RightService();
        
        // Prepare Templare Service and Standard Values!
        $TEMPLATE_SERVICE = new TemplateService();
        $TEMPLATE_SERVICE->addTemplateDirectory($GLOBALS['_BIGACE']['style']['class']->getTemplateDirectory());
        $TEMPLATE_SERVICE->addTemplateDirectory(_ADMIN_TEMPLATE_DIRECTORY);
        setBigaceTemplateValue('PUBLIC_DIR', $GLOBALS['_BIGACE']['DIR']['public']);
        setBigaceTemplateValue('STYLE_DIR', $GLOBALS['_BIGACE']['style']['DIR']);
        setBigaceTemplateValue('STYLE_CSS', $GLOBALS['_BIGACE']['style']['class']->getCSS());
        setBigaceTemplateValue('BIGACE_VERSION', _BIGACE_ID);
        setBigaceTemplateValue('SMALL_FORM', ADMIN_MASK_WIDTH_SMALL);
        setBigaceTemplateValue('LARGE_FORM', ADMIN_MASK_WIDTH_LARGE);
        
        // Maximum File Sizes for a Upload in Bytes
        $UPLOAD_MAX_SIZE = ConfigurationReader::getConfigurationValue('admin', 'max.upload.size'); 
           
        // #################### ADMINISTRATION MENU IDs #######################
        define ('_ADMIN_ID_MAIN',               'index');
        
        // SUB MENU ADMIN PLUGINs for linking
        define ('_ADMIN_ID_MENU_CREATE',        'itemMenuCreate');
        define ('_ADMIN_ID_USER_ADMIN',         'userAdmin');
        define ('_ADMIN_ID_CATEGORY_ADMIN',     'categoryAdmin');
        define ('_ADMIN_ID_FRIGHT_ADMIN',       'frightListing');
        define ('_ADMIN_ID_CATEGORY_CREATE',    'categoryCreate');
        define ('_ADMIN_ID_FILE_MAIN',          'fileAdmin');
        define ('_ADMIN_ID_IMAGE_MAIN',         'imagesAdmin');
        define ('_ADMIN_ID_WELCOME',            'welcome');
        
        define ('_LANGUAGE_PARAM', 'languageID');
        // ####################################################################
        
        // load global admin translation
    	Translations::loadGlobal('administration', ADMIN_LANGUAGE);
    	Translations::loadGlobal('bigace', ADMIN_LANGUAGE);

        // All Menu information will be kept inside here!
        $GLOBALS['_BIGACE']['ADMIN']['menu'] = array();
        // load all predefined menus        
        require_once(_BIGACE_DIR_ADMIN.'menuStructure.php');

        // --------------------------------------------------------------------------
        // that it, now the requested admin plugin is loaded... if it exists ;)
        if(file_exists($MENU->getFileName())) {
            if(check_admin_permission($MENU->getPermissions())) {
                $GLOBALS['TEMPLATE_SERVICE']->addTemplateDirectory($MENU->getPath());
                //include(_ADMIN_PLUGIN_DIRECTORY . $GLOBALS['_BIGACE']['PARSER']->getItemID() . '.php');
                if($MENU->isTranslated()) {
                    $MENU->loadTranslation();
                }
                include($MENU->getFileName());
            }
            else {
                import('classes.exception.NoFunctionalRightException');
                ExceptionHandler::processAdminException( new NoFunctionalRightException('Protected Area. You are not allowed to enter!', createAdminLink(_ADMIN_ID_MAIN)) );
                $GLOBALS['LOGGER']->logInfo("** User with ID: ".$GLOBALS['_BIGACE']['SESSION']->getUserID()." tried to access Administration Menu '".$MENU->getID()."' without sufficient rights **");
            }
        } 
        else {
            import('classes.exception.NotFoundException');
            ExceptionHandler::processCoreException( new NotFoundException(404, 'Could not find Admin Plugin: '.$MENU->getID()) );
        }
}
else 
{
	// changed for 2.4 - show login instead of error message 
	import('classes.util.LinkHelper');
	import('classes.util.links.LoginFormularLink');
	$lfl = new LoginFormularLink();
	$lfl->setRedirectID($GLOBALS['_BIGACE']['PARSER']->getItemID());
	$lfl->setRedirectCommand($GLOBALS['_BIGACE']['PARSER']->getCommand());
	header('Location: ' . LinkHelper::getUrlFromCMSLink($lfl));
//    ExceptionHandler::processCoreException( new NotAllowedException('anonymous', 'Anonymous User are NOT allowed to access the Administration Panel!') );
}

if (!$GLOBALS[HIDE_ADMIN_FOOTER]) {
    include_once(_BIGACE_DIR_LIBS.'footer.inc.php');
}

?>