<?php
/**
 * BIGACE - a PHP and MySQL based Web CMS.
 * Copyright (C) Kevin Papst.
 *
 * BIGACE is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * BIGACE is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
 *
 * For further information visit {@link http://www.kevinpapst.de www.kevinpapst.de}.
 *
 * @version $Id$
 * @author Kevin Papst 
 * @package bigace.administration
 * @subpackage item.menu
 */

/**
 * Plugin used to display the Menu Tree administration.
 */

define('_PUBLIC_TREE_DIR', $GLOBALS['_BIGACE']['DIR']['public'].'system/webfx/xloadtree111/');
define('TREE_STYLE_DIR', $GLOBALS['_BIGACE']['style']['DIR'] . 'menutree/');

// general parameter and modes
define('_PARAM_TREE_MODE', 'mode');              // the mode switches between first level modes
define('_PARAM_AJAX_CMD', 'ajaxCmd');            // the name of the ajax command to be executed
define('_MODE_XML', 'xml');                      // this mode defines the request as xml based ajax
define('_MODE_REORDER', 'reorder');              // this mode request the reorder screen
define('_MODE_LISTING', 'initial');              // mode that displays the tree, action form, toolbar...
define('_MODE_SHOW_EDIT_ITEM', 'editMyItemNow');

// ajax parameter
define('_PARAM_PARENT_ID', 'parentId');          // the (new) parent of the item id the request was performed for
define('_PARAM_TREE_ID', 'treeId');              // the item id the request was performed for
define('_PARAM_AJAX_MSG', 'text');               // the result text for user feedback

import('classes.menu.Menu');

require_once(_ADMIN_INCLUDE_DIRECTORY.'/mode_constants.php');

import('classes.item.ItemService');
import('classes.menu.MenuAdminService');
import('classes.administration.MenuAdminMask');
import('classes.util.ApplicationLinks');

// load required xml functions
include_once( dirname(__FILE__).'/xml.php');

$_ITEMTYPE     = _BIGACE_ITEM_MENU;
$_ADMIN        = new MenuAdminService();

if (!isset($_SERVICE)) {
    $_SERVICE = new ItemService(_BIGACE_ITEM_MENU);
}

// ----------------- SCRIPT LOGIC BEGINS ----------------------------

$myMode = extractVar(_PARAM_TREE_MODE, _MODE_LISTING);
if($myMode == _MODE_XML)
{
    $GLOBALS[HIDE_ADMIN_FOOTER] = TRUE;
    $ajaxCmd = extractVar(_PARAM_AJAX_CMD, null);
    if($ajaxCmd != null) {
        require_once(dirname(__FILE__).'/ajaxcmd/'.$ajaxCmd.'.php');
        $cmd = new $ajaxCmd();
        $cmd->execute();
        unset($cmd);
    } else {
        $GLOBALS['LOGGER']->logError("Failed performing AJAX Command, missing Command name!");
    }
}
else if($myMode == _MODE_REORDER)
{
    include_once(dirname(__FILE__).'/reorder.php');
}
else
{
    // this is the main view that renders the tree, tooolbar, action links...
    include_once(dirname(__FILE__).'/menu_item_listing.php');
    include_once(_ADMIN_INCLUDE_DIRECTORY.'item_main.php' );
}

// ----------------------------------------------------------
// NEEDED FOR item_main.php
// ----------------------------------------------------------

function createAdminMask($itemtype) {
    $mask = new MenuAdminMask();
    $mask->setLargeMode(false);
    return $mask;
}

function createEditDataMaskForm($data, $item)
{
    $GLOBALS[HIDE_ADMIN_FOOTER] = TRUE;
    $mask = createAdminMask(_BIGACE_ITEM_MENU);
    $mask->editItem($item->getID(), $item->getLanguageID());
}

?>
